DATE   Jan 18, 2012
AUTHOR Jake jake@keyboardfu.com
TAG    PHP
TAG    Filters

h1. Safe Input With PHP's Filter Functions, I

In any web application that does more than just barf content to the user's browser, users are allowed to provide input. The input could be as simple as the page number in a paged list of items, or as complex as a site-wide unique username containing only a subset of characters. The question becomes one of trust: Do you really trust the person on the other end of the screen isn't going to fiddle with values to make your site fall over and drool?

h2. Not Just Another @filter_input@ Article

There are plenty of articles on the web regarding the use of @filter_input@ and it's friends. To learn about the basics, go read those and come back. I'll let them soapbox the _Thou Shalt Always Filter Thine Inputs_ speech.

This article is part of a multi-part[#multi-part] series where we'll look at efficiently managing and applying filters in a more centralized and collaborative environment.

note#multi-part. Feel free to substitute an arbitrary non-negative integer here, I'm feeling non-committal.

h2. First Things First: @FILTER_CALLBACK@

Callbacks are the red-headed step child of PHP's goodie bag. They aren't as widely used as in some other languages, but they do shine when they're used correctly.

h3. Filter With a Built-In

For a rudamentary demonstration, I shall now -pull a rabbit out of my hat- filter a value using a PHP built-in function, "strlen":http://php.net/function.strlen.php.

bc. $value = filter_var('monkey', FILTER_CALLBACK, array('options' => 'strlen'));

Congratulations, you just took the user's input and threw it away because all you wanted was it's length. Useless? Maybe not.

h3. Filter With a User Function

A much more likely case for filter callbacks involves writing your own function and using that to filter user input. Same song and dance as the previous example:

bc. function myFilter($value) {
	return date('c', strtotime($value));
}
$value = filter_var('monkey', FILTER_CALLBACK, array('options' => 'myFilter'));

Marginally more robust as we take the user's input, cast it to a timestamp, and then format it to a date string. This is actually starting to get useful, but I already hate typing out @FILTER_CALLBACK, array('options' => 'myFunc')@.

h2. Saving Time With Centralized Custom Filters

The goal is to save development time and gain consistency. Trying to remember the syntax for that array is annoying. Also, what happens if one developer creates a time-cast function for one site, and you need one so you go through the motions of recreating it? That wheel's going to be square after enough reinventions.

The obvious jump is a small, static, class. We'll call it @CustomFilters@. This class will hold a few static methods which validate or filter when passed in as the callback for a filter function. To place something from the @CustomFilters@ class, say a timestamp-casting filter:

bc. $value = filter_var('monkey', FILTER_CALLBACK, array(
	'options' => array(
		'CustomFilters', 'castTimestamp'
	)
));

But, this has that goofy syntax again, and I just said I hate it.

h2. Enter @filter_input_array@

To help out with the next section, you need a firm grasp of @filter_input_array@ or @filter_var_array@. This is the psychotic cousin to the tame @filter_input@ and @filter_var@, which only work on one value at a time. The former filtering functions take an array mapping of some key and map it to one of the following:

# A single filter (@FILTER_SANITIZE_STRING@)
# A single filter with a bunch of options

h3. Simple Filtering

bc. $values = filter_input_array(INPUT_POST, array(
	'transfer_date' => FILTER_SANITIZE_STRING,
	'desired_funds'  => FILTER_VALIDATE_INT
));

Child's play.

h3. Bunch of Options

bc. $values = filter_input_array(INPUT_POST, array(
	'transfer_date' => array(
		'filter' => FILTER_CALLBACK,
		'options' => 'strtotime'
	),
	'desired_funds' => array(
		'filter' => FILTER_VALIDATE_INT,
		'options' => array(
			'min_range' => 1,
			'max_range' => 1e6
		)
	)
));

A million dollars sounds great, how about we transfer that _now_[#strtotime-now]!

note#strtotime-now. Yes, _now_ is a valid value for @strtotime@.

h2. Footnotes

notelist.
